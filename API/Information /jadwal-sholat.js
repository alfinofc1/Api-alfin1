const axios = require('axios');
const cheerio = require('cheerio');

module.exports = async (req, res) => {
  const cityMapping = {
    "aceh barat": "317",
    "aceh barat daya": "318",
    "aceh besar": "319",
    "aceh jaya": "320",
    "aceh selatan": "321",
    "aceh singkil": "322",
    "aceh tamiang": "323",
    "aceh tengah": "324",
    "aceh tenggara": "325",
    "aceh timur": "326",
    "aceh utara": "327",
    "agam": "329",
    "alor": "330",
    "ambarawa": "1",
    "ambon": "2",
    "amlapura": "3",
    "amuntai": "4",
    "argamakmur": "5",
    "asahan": "331",
    "asmat": "332",
    "atambua": "6",
    "babo": "7",
    "badung": "333",
    "bagan siapiapi": "8",
    "bahaur, kalteng": "316",
    "bajawa": "9",
    "balangan": "334",
    "balige": "10",
    "balikpapan": "11",
    "banda aceh": "12",
    "bandar lampung": "335",
    "bandarlampung": "13",
    "bandung": "14",
    "bandung barat": "336",
    "banggai": "337",
    "banggai kepulauan": "338",
    "banggai laut": "339",
    "bangka": "340",
    "bangka barat": "341",
    "bangka selatan": "342",
    "bangka tengah": "343",
    "bangkalan": "15",
    "bangkinang": "16",
    "bangko": "17",
    "bangli": "18",
    "banjar": "19",
    "banjar baru": "20",
    "banjarbaru": "344",
    "banjarmasin": "21",
    "banjarnegara": "22",
    "bantaeng": "23",
    "banten": "24",
    "bantul": "25",
    "banyuasin": "345",
    "banyumas": "346",
    "banyuwangi": "26",
    "barabai": "27",
    "barito": "28",
    "barito kuala": "347",
    "barito selatan": "348",
    "barito timur": "349",
    "barito utara": "350",
    "barru": "29",
    "batam": "30",
    "batang": "31",
    "batanghari": "351",
    "batu": "32",
    "batu bara": "352",
    "baturaja": "33",
    "batusangkar": "34",
    "bau bau": "353",
    "baubau": "35",
    "bekasi": "36",
    "belitung": "354",
    "belitung timur": "355",
    "belu": "356",
    "bener meriah": "357",
    "bengkalis": "37",
    "bengkayang": "358",
    "bengkulu": "38",
    "bengkulu selatan": "359",
    "bengkulu tengah": "360",
    "bengkulu utara": "361",
    "benteng": "39",
    "berau": "362",
    "biak": "40",
    "biak numfor": "363",
    "bima": "41",
    "binjai": "42",
    "bintan": "364",
    "bireuen": "43",
    "bitung": "44",
    "blitar": "45",
    "blora": "46",
    "boalemo": "365",
    "bogor": "47",
    "bojonegoro": "48",
    "bolaang mongondow": "366",
    "bolaang mongondow selatan": "367",
    "bolaang mongondow timur": "368",
    "bolaang mongondow utara": "369",
    "bombana": "370",
    "bondowoso": "49",
    "bone": "371",
    "bone bolango": "372",
    "bontang": "50",
    "boven digoel": "373",
    "boyolali": "51",
    "brebes": "52",
    "bukit tinggi": "53",
    "bukittinggi": "374",
    "bula sbt, maluku": "315",
    "buleleng": "375",
    "bulukumba": "54",
    "bulungan": "376",
    "bungo": "377",
    "buntok": "55",
    "buol": "378",
    "buru": "379",
    "buru selatan": "380",
    "buton": "381",
    "buton selatan": "382",
    "buton tengah": "383",
    "buton utara": "384",
    "cepu": "56",
    "ciam": "57",
    "cianjur": "58",
    "cibinong": "59",
    "cilacap": "60",
    "cilegon": "61",
    "cimahi": "62",
    "cirebon": "63",
    "curup": "64",
    "dairi": "385",
    "deiyai": "386",
    "deli serdang": "387",
    "demak": "65",
    "denpasar": "66",
    "depok": "67",
    "dharmasraya": "388",
    "dili": "68",
    "dogiyai": "389",
    "dompu": "69",
    "donggala": "70",
    "dumai": "71",
    "empat lawang": "390",
    "ende": "72",
    "enggano": "73",
    "enrekang": "74",
    "fak fak": "391",
    "fakfak": "75",
    "flores timur": "392",
    "garut": "76",
    "gayo lues": "393",
    "gianyar": "77",
    "gombong": "78",
    "gorontalo": "79",
    "gorontalo utara": "394",
    "gowa": "395",
    "gresik": "80",
    "grobogan": "396",
    "gunung mas": "397",
    "gunung sitoli": "81",
    "gunungkidul": "398",
    "gunungsitoli": "399",
    "halmahera barat": "400",
    "halmahera selatan": "401",
    "halmahera tengah": "402",
    "halmahera timur": "403",
    "halmahera utara": "404",
    "hulu sungai selatan": "405",
    "hulu sungai tengah": "406",
    "hulu sungai utara": "407",
    "humbang hasundutan": "408",
    "indragiri hilir": "409",
    "indragiri hulu": "410",
    "indramayu": "82",
    "intan jaya": "411",
    "jakarta barat": "309",
    "jakarta pusat": "308",
    "jakarta selatan": "310",
    "jakarta timur": "311",
    "jakarta utara": "312",
    "jambi": "83",
    "jayapura": "84",
    "jayawijaya": "412",
    "jember": "85",
    "jembrana": "413",
    "jeneponto": "86",
    "jepara": "87",
    "jombang": "88",
    "kab timor tengah selatan": "414",
    "kaimana": "415",
    "kabanjahe": "89",
    "kalabahi": "90",
    "kalianda": "91",
    "kampar": "416",
    "kandangan": "92",
    "karanganyar": "93",
    "karangasem": "419",
    "karawang": "94",
    "karimun": "420",
    "karo": "421",
    "kasungan": "95",
    "katingan": "422",
    "kaur": "423",
    "kayong utara": "424",
    "kayuagung": "96",
    "kebumen": "97",
    "kediri": "98",
    "keerom": "425",
    "kefamenanu": "99",
    "kendal": "100",
    "kendari": "101",
    "kep. seribu": "328",
    "kep. siau tagulandang biaro": "426",
    "kepahiang": "427",
    "kepulauan anambas": "428",
    "kepulauan aru": "429",
    "kepulauan mentawai": "430",
    "kepulauan meranti": "431",
    "kepulauan sangihe": "432",
    "kepulauan selayar": "433",
    "kepulauan sula": "434",
    "kepulauan talaud": "435",
    "kepulauan tanimbar": "436",
    "kepulauan yapen": "437",
    "kerinci": "438",
    "kertosono": "102",
    "ketapang": "103",
    "kisaran": "104",
    "klaten": "105",
    "kolaka": "106",
    "kolaka timur": "440",
    "kolaka utara": "441",
    "konawe": "442",
    "konawe kepulauan": "443",
    "konawe selatan": "444",
    "konawe utara": "445",
    "kota baru pulau laut": "107",
    "kota bumi": "108",
    "kota jantho": "109",
    "kotabaru": "446",
    "kotamobagu": "110",
    "kotawaringin barat": "447",
    "kotawaringin timur": "448",
    "kuala kapuas": "111",
    "kuala kurun": "112",
    "kuala pembuang": "113",
    "kuala tungkal": "114",
    "kuantan singingi": "449",
    "kubu raya": "450",
    "kudus": "115",
    "kulon progo": "451",
    "kuningan": "116",
    "kupang": "117",
    "kutacane": "118",
    "kutai barat": "452",
    "kutai kartanegara": "453",
    "kutai timur": "454",
    "kutoarjo": "119",
    "labuhan": "120",
    "labuhan batu": "455",
    "labuhan batu selatan": "456",
    "labuhan batu utara": "457",
    "lahat": "121",
    "lamandau": "458",
    "lamongan": "122",
    "lampung barat": "459",
    "lampung selatan": "460",
    "lampung tengah": "461",
    "lampung timur": "462",
    "lampung utara": "463",
    "landak": "464",
    "langkat": "465",
    "langsa": "123",
    "lanny jaya": "466",
    "larantuka": "124",
    "lawang": "125",
    "lebak": "467",
    "lebong": "468",
    "lembata": "469",
    "lhokseumawe": "470",
    "lhoseumawe": "126",
    "lima puluh kota": "471",
    "limboto": "127",
    "lingga": "472",
    "lombok barat": "473",
    "lombok tengah": "474",
    "lombok timur": "475",
    "lombok utara": "476",
    "lubuk basung": "128",
    "lubuk linggau": "129",
    "lubuk pakam": "130",
    "lubuk sikaping": "131",
    "lumajang": "132",
    "luwu": "477",
    "luwu timur": "478",
    "luwu utara": "479",
    "luwuk": "133",
    "madiun": "134",
    "magelang": "135",
    "magetan": "136",
    "mahakam ulu": "480",
    "majalengka": "137",
    "majene": "138",
    "makale": "139",
    "makassar": "140",
    "malaka": "481",
    "malang": "141",
    "malinau": "482",
    "maluku barat daya": "483",
    "maluku tengah": "484",
    "maluku tenggara": "485",
    "maluku utara": "486",
    "mamasa": "486",
    "mamberamo raya": "487",
    "mamberamo tengah": "488",
    "mamuju": "142",
    "mamuju tengah": "489",
    "manado": "490",
    "mandailing natal": "491",
    "manggarai": "492",
    "manggarai barat": "493",
    "manggarai timur": "494",
    "manna": "143",
    "manokwari": "144",
    "manokwari selatan": "495",
    "mappi": "496",
    "marabahan": "145",
    "maros": "146",
    "martapura kalsel": "147",
    "masamba, sulsel": "314",
    "masohi": "148",
    "mataram": "149",
    "maumere": "150",
    "maybrat": "497",
    "medan": "151",
    "melawi": "498",
    "mempawah": "152",
    "menado": "153",
    "mentok": "154",
    "merangin": "499",
    "merauke": "155",
    "mesuji": "500",
    "metro": "156",
    "meulaboh": "157",
    "mimika": "501",
    "minahasa": "502",
    "minahasa selatan": "503",
    "minahasa tenggara": "504",
    "minahasa utara": "505",
    "mojokerto": "158",
    "morowali": "506",
    "morowali utara": "507",
    "muara bulian": "159",
    "muara bungo": "160",
    "muara enim": "161",
    "muara teweh": "162",
    "muaro jambi": "508",
    "muaro sijunjung": "163",
    "muko muko": "509",
    "muna": "510",
    "muna barat": "511",
    "muntilan": "164",
    "murung raya": "512",
    "musi banyuasin": "513",
    "musi rawas": "514",
    "musi rawas utara": "515",
    "nabire": "165",
    "nagan raya": "516",
    "nagekeo": "517",
    "natuna": "518",
    "nduga": "519",
    "negara": "166",
    "ngada": "520",
    "nganjuk": "167",
    "ngawi": "168",
    "nias": "521",
    "nias barat": "522",
    "nias selatan": "523",
    "nias utara": "524",
    "nunukan": "169",
    "ogan ilir": "525",
    "ogan komering ilir": "526",
    "ogan komering ulu": "527",
    "ogan komering ulu selatan": "528",
    "ogan komering ulu timur": "529",
    "pacitan": "170",
    "padang": "171",
    "padang lawas": "530",
    "padang lawas utara": "531",
    "padang panjang": "172",
    "padang pariaman": "532",
    "padang sidempuan": "173",
    "padangsidimpuan": "533",
    "pagar alam": "534",
    "pagaralam": "174",
    "pahuwato": "535",
    "painan": "175",
    "pakpak bharat": "536",
    "palangkaraya": "176",
    "palembang": "177",
    "palopo": "178",
    "palu": "179",
    "pamekasan": "180",
    "pandeglang": "181",
    "pangka_": "182",
    "pangkajene sidenreng": "183",
    "pangkalan bun": "184",
    "pangkalpinang": "185",
    "panyabungan": "186",
    "pare": "187",
    "parepare": "188",
    "pariaman": "189",
    "pasuruan": "190",
    "pati": "191",
    "payakumbuh": "192",
    "pekalongan": "193",
    "pekan baru": "194",
    "pemalang": "195",
    "pematangsiantar": "196",
    "pendopo": "197",
    "pinrang": "198",
    "pleihari": "199",
    "polewali": "200",
    "pondok gede": "201",
    "ponorogo": "202",
    "pontianak": "203",
    "poso": "204",
    "prabumulih": "205",
    "praya": "206",
    "probolinggo": "207",
    "purbalingga": "208",
    "purukcahu": "209",
    "purwakarta": "210",
    "purwodadigrobogan": "211",
    "purwokerto": "212",
    "purworejo": "213",
    "putussibau": "214",
    "raha": "215",
    "rangkasbitung": "216",
    "rantau": "217",
    "rantauprapat": "218",
    "rantepao": "219",
    "rembang": "220",
    "rengat": "221",
    "ruteng": "222",
    "sabang": "223",
    "salatiga": "224",
    "samarinda": "225",
    "sambas, kalbar": "313",
    "sampang": "226",
    "sampit": "227",
    "sanggau": "228",
    "sawahlunto": "229",
    "sekayu": "230",
    "selong": "231",
    "semarang": "232",
    "sengkang": "233",
    "serang": "234",
    "serui": "235",
    "sibolga": "236",
    "sidikalang": "237",
    "sidoarjo": "238",
    "sigli": "239",
    "singaparna": "240",
    "singaraja": "241",
    "singkawang": "242",
    "sinjai": "243",
    "sintang": "244",
    "situbondo": "245",
    "slawi": "246",
    "sleman": "247",
    "soasiu": "248",
    "soe": "249",
    "solo": "250",
    "solok": "251",
    "soreang": "252",
    "sorong": "253",
    "sragen": "254",
    "stabat": "255",
    "subang": "256",
    "sukabumi": "257",
    "sukoharjo": "258",
    "sumbawa besar": "259",
    "sumedang": "260",
    "sumenep": "261",
    "sungai liat": "262",
    "sungai penuh": "263",
    "sungguminasa": "264",
    "surabaya": "265",
    "surakarta": "266",
    "tabanan": "267",
    "tahuna": "268",
    "takalar": "269",
    "takengon": "270",
    "tamiang layang": "271",
    "tanah grogot": "272",
    "tangerang": "273",
    "tanjung balai": "274",
    "tanjung enim": "275",
    "tanjung pandan": "276",
    "tanjung pinang": "277",
    "tanjung redep": "278",
    "tanjung selor": "279",
    "tapak tuan": "280",
    "tarakan": "281",
    "tarutung": "282",
    "tasikmalaya": "283",
    "tebing tinggi": "284",
    "tegal": "285",
    "temanggung": "286",
    "tembilahan": "287",
    "tenggarong": "288",
    "ternate": "289",
    "tolitoli": "290",
    "tondano": "291",
    "trenggalek": "292",
    "tual": "293",
    "tuban": "294",
    "tulung agung": "295",
    "ujung berung": "296",
    "ungaran": "297",
    "waikabubak": "298",
    "waingapu": "299",
    "wamena": "300",
    "watampone": "301",
    "watansoppeng": "302",
    "wates": "303",
    "wonogiri": "304",
    "wonosari": "305",
    "wonosobo": "306",
    "yogyakarta": "307"
  };

  const cityList = Object.keys(cityMapping).map(key => ({ name: key.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ').replace(/,/g, ', '), id: cityMapping[key] }));

  const baseUrl = 'https://jadwalsholat.org/jadwal-sholat/ajax/ajax.daily1.php';
  const headers = {
    'User-Agent': 'Mozilla/5.0 (Linux; Android 10; RMX2185 Build/QP1A.190711.020) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.7049.111 Mobile Safari/537.36',
    'Referer': 'https://jadwalsholat.org/jadwal-sholat/ajax.row.php'
  };

  try {
    const cityParam = req.query.city;
    if (!cityParam) {
      res.errorJson({ error: 'Eh, kota mana nih yang mau dicari?', available_cities: cityList }, 400);
      return;
    }

    const normalizedCity = cityParam.toLowerCase().trim();
    const cityId = cityMapping[normalizedCity];

    if (!cityId) {
      res.errorJson({ error: `Waduh, kota "${cityParam}" nggak nemu nih di daftar. Coba cek lagi.`, available_cities: cityList }, 400);
      return;
    }

    const url = `${baseUrl}?id=${cityId}`;

    const response = await axios.get(url, { headers });
    const $ = cheerio.load(response.data);

    const year = $('#yr').val();
    const month = $('#mn').val();
    const day = $('#dt').val();
    const type = $('#tp').val();
    const date = $('.table_adzan2 tr:nth-child(1) b').text().trim();

    const shubuh = $('.table_adzan2 tr:nth-child(3) td:nth-child(2)').text().trim();
    const dzuhur = $('.table_adzan2 tr:nth-child(4) td:nth-child(2)').text().trim();
    const ashr = $('.table_adzan2 tr:nth-child(5) td:nth-child(2)').text().trim();
    const maghrib = $('.table_adzan2 tr:nth-child(6) td:nth-child(2)').text().trim();
    const isya = $('.table_adzan2 tr:nth-child(7) td:nth-child(2)').text().trim();

    const prayerTimes = {
      shubuh,
      dzuhur,
      ashr,
      maghrib,
      isya
    };

    res.successJson({
      city: cityParam,
      city_id: cityId,
      date,
      year,
      month,
      day,
      type,
      prayer_times: prayerTimes
    });

  } catch (e) {
    if (e.response && e.response.status === 400) {
         res.errorJson({ error: `Gagal ambil data nih buat ID kota ${cityId}. Coba cek daftar kota ya.`, available_cities: cityList }, 400);
    } else {
         res.errorJson({ error: 'Yah, gagal nyedot data jadwal sholat nih. Coba lagi nanti ya.' }, 500);
    }
  }
};
